name: Create Infrastructure

on:
  workflow_dispatch:

permissions:
  actions: write
  contents: read

jobs:
  create-infra:
    name: Create DigitalOcean Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Create Kubernetes Cluster
        run: |
          doctl kubernetes cluster create k8sgametemplate-cluster \
            --region=nyc3 \
            --version=latest \
            --node-pool "name=np1;size=s-2vcpu-4gb;count=1" || \
            echo "Error creating cluster or cluster already exists"

      - name: Create Container Registry
        run: |
          doctl registry create "k8sgametemplate-${{ github.repository_id }}" || \
            echo "Error creating registry or registry already exists"

      - name: Link Container Registry to K8s Cluster
        run: |
          doctl kubernetes cluster registry add k8sgametemplate-cluster || \
            echo "Error linking registry to cluster or link already exists"

      - name: Install NGINX Ingress Controller
        run: |
          CLUSTER_ID=$(doctl kubernetes cluster get k8sgametemplate-cluster --format ID --no-header)
          doctl kubernetes 1-click install $CLUSTER_ID --1-clicks ingress-nginx

      - name: Wait for NGINX LoadBalancer IP
        id: nginxip
        run: |
          echo "Aguardando IP do LoadBalancer do NGINX..."

          for i in {1..90}; do
            LB_IP=$(doctl compute load-balancer list --format IP --no-header | head -n 1)
            
            if [ -n "$LB_IP" ]; then
              echo "LoadBalancer IP encontrado: $LB_IP"
              echo "lb_ip=$LB_IP" >> $GITHUB_OUTPUT
              break
            fi

            echo "Ainda não disponível, aguardando 10s..."
            sleep 10
          done

          if [ -z "$LB_IP" ]; then
            echo "LoadBalancer IP não encontrado após 90 tentativas!"
            exit 1
          fi

      - name: Create DNS Record
        run: |
          SANITIZED_USER=$(echo "${GITHUB_ACTOR}" | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          DOMAIN_NAME="$SANITIZED_USER.k8sgame.win"

          echo "Creating DNS record for $DOMAIN_NAME -> ${{ steps.nginxip.outputs.lb_ip }}"

          curl --location "https://snqmhdtqdoubqwompatc.supabase.co/functions/v1/creatednsrecord" \
            --header "Content-Type: application/json" \
            --data "{
              \"domainName\": \"novoTest\",
              \"ipAddress\": \"${{ steps.nginxip.outputs.lb_ip }}\"
            }"

      - name: Trigger CI-CD
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "ci-cd.yaml",
              ref: "main"
            });
