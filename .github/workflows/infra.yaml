name: Create Kubernetes Cluster (Infra)

on:
  workflow_dispatch:

jobs:
  create-infra:
    name: Create DigitalOcean Infrastructure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Compute dynamic variables
        id: vars
        run: |
          REG_NAME="${{ github.actor }}-k8sgametemplate"
          echo "reg_name=$REG_NAME" >> $GITHUB_OUTPUT

      - name: Create Kubernetes Cluster
        run: |
          doctl kubernetes cluster create demo-cluster \
            --region=nyc1 \
            --version=latest \
            --tag=demo \
            --node-pool "name=np1;size=s-2vcpu-4gb;count=1" || \
            echo "Cluster already exists"

      - name: Wait for Cluster Readiness
        run: doctl kubernetes cluster wait demo-cluster

      - name: Create Container Registry
        run: |
          doctl registry create ${{ steps.vars.outputs.reg_name }} || \
            echo "Registry already exists"

      - name: Extract registry info
        id: registry
        run: |
          SERVER=$(doctl registry get ${{ steps.vars.outputs.reg_name }} --format Server | tail -n 1)
          echo "server=$SERVER" >> $GITHUB_OUTPUT

      - name: Download kubeconfig
        run: |
          mkdir -p infra-output
          doctl kubernetes cluster kubeconfig save demo-cluster
          cp ~/.kube/config infra-output/kubeconfig

      - name: Create infra.json
        run: |
          echo "{" > infra-output/infra.json
          echo "\"registry_name\": \"${{ steps.vars.outputs.reg_name }}\"," >> infra-output/infra.json
          echo "\"registry_server\": \"${{ steps.registry.outputs.server }}\"," >> infra-output/infra.json
          echo "\"registry_username\": \"do\"," >> infra-output/infra.json
          echo "\"kubeconfig\": \"$(sed ':a;N;$!ba;s/\n/\\n/g' infra-output/kubeconfig)\"" >> infra-output/infra.json
          echo "}" >> infra-output/infra.json

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: infra-data
          path: infra-output
