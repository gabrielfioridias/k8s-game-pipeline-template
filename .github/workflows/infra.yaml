name: Create Kubernetes Cluster (Infra)

on:
  workflow_dispatch:

jobs:
  create-infra:
    name: Create Kubernetes Cluster + Registry
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Instala e configura o doctl
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      # Gera nome único para o Container Registry
      - name: Define registry name
        id: reg
        run: |
          REGISTRY_NAME="${{ github.actor }}-k8sgametemplate"
          REGISTRY_URL="registry.digitalocean.com/${REGISTRY_NAME}"

          echo "REGISTRY_NAME=$REGISTRY_NAME" >> $GITHUB_OUTPUT
          echo "REGISTRY_URL=$REGISTRY_URL" >> $GITHUB_OUTPUT

      # Criação do Container Registry (ignora erro se já existir)
      - name: Create Container Registry
        run: |
          echo "Creating registry ${{ steps.reg.outputs.REGISTRY_NAME }} ..."
          doctl registry create \
             ${{ steps.reg.outputs.REGISTRY_NAME }} \
             --subscription-tier basic || echo "Registry may already exist"

      # Salva nome e URL do registry nas secrets
      - name: Save registry info to GitHub Secrets
        uses: gliech/create-github-secret-action@v1
        with:
          secret-name: REGISTRY_NAME
          secret-value: ${{ steps.reg.outputs.REGISTRY_NAME }}

      - name: Save registry URL to GitHub Secrets
        uses: gliech/create-github-secret-action@v1
        with:
          secret-name: REGISTRY_URL
          secret-value: ${{ steps.reg.outputs.REGISTRY_URL }}

      # Criação do cluster
      - name: Create Kubernetes Cluster
        run: |
          echo "Creating Kubernetes cluster..."
          doctl kubernetes cluster create demo-cluster \
            --region=nyc1 \
            --version=latest \
            --tag=demo \
            --node-pool "name=np1;size=s-2vcpu-4gb;count=1" || \
            echo "Cluster may already exist"

      # Aguarda ficar pronto
      - name: Wait for cluster readiness
        run: |
          echo "Waiting for Kubernetes cluster to become ready..."
          doctl kubernetes cluster wait demo-cluster

      # Linka o registry ao cluster (pull secrets automáticos)
      - name: Link Registry to Kubernetes Cluster
        run: |
          echo "Linking registry to cluster..."
          doctl kubernetes cluster registry add demo-cluster ${{ steps.reg.outputs.REGISTRY_NAME }} || echo "Already linked"

      # Baixa o kubeconfig
      - name: Download kubeconfig
        id: kube
        run: |
          mkdir -p kube
          doctl kubernetes cluster kubeconfig save demo-cluster
          cp ~/.kube/config kube/kubeconfig

          # Converte kubeconfig para string única (necessário para secrets)
          KUBECONFIG_CONTENT=$(sed ':a;N;$!ba;s/\n/\\n/g' kube/kubeconfig)
          echo "value=$KUBECONFIG_CONTENT" >> $GITHUB_OUTPUT

      # Salva o kubeconfig no GitHub Secrets automaticamente
      - name: Save kubeconfig to GitHub Secrets
        run: |
          echo "${{ steps.kube.outputs.value }}" | gh secret set KUBECONFIG
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
